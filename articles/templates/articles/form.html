<!-- this works -->
{% extends "base.html" %}
{% load static %}
{% block content %}
{{ form.media }}

<a href="{% url 'article_list' %}" class="btn btn-primary">Back</a><br><br>
<h3>{% if form.instance.pk %}Edit Article – {{ form.instance.title }}{% else %}Add Article{% endif %}</h3>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    
    {{ form.title.label_tag }}
    {{ form.title }}<br><br>

    {{ form.sub_title.label_tag }}
    {{ form.sub_title }}<br><br>

    {{ form.slug.label_tag }}
    {{ form.slug }}<br>
    <span id="slug-warning" style="color:red; display:none;">Slug already exists!</span><br>

    {{ form.content.label_tag }}
    {{ form.content }}<br><br>
    <button type="button" id="readmore-btn" class="btn btn-warning mb-3">
    Read More
    </button><br> <br>

<div class="mb-3">
    <!-- Label -->
    {{ form.image.label_tag }}

    <!-- Default file input (Choose File button) -->
    <div id="file-input-container" {% if form.instance and form.instance.image %}style="display:none;"{% endif %}>
        {{ form.image }}
    </div>

    <!-- IMAGE PATH BELOW BUTTON -->
    <div id="image-path" style="margin-top: 5px; font-size: 0.9rem; color: #555;">
        {% if form.instance and form.instance.image %}
            Path: {{ form.instance.image.url }}
        {% endif %}
    </div>

    <!-- IMAGE PREVIEW WITH RED × BUTTON -->
    <div id="image-preview-container" style="position: relative; display: inline-block; margin-top: 5px;">
        <img id="preview" width="200" style="display: {% if form.instance and form.instance.image %}block{% else %}none{% endif %}; border-radius:8px;" 
             src="{% if form.instance and form.instance.image %}{{ form.instance.image.url }}{% endif %}" />

        <!-- Red × button -->
        <button type="button" id="remove-image-btn" style="
            position: absolute;
            top: -10px;
            right: -10px;
            background: red;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: {% if form.instance and form.instance.image %}flex{% else %}none{% endif %};
            align-items: center;
            justify-content: center;
        ">×</button>
    </div>
</div>


    {{ form.homepage.label_tag }}
    {{ form.homepage }}<br><br>

    {{ form.status.label_tag }}
    {{ form.status }}<br><br>

    {{ form.meta_title.label_tag }}
    {{ form.meta_title }}<br><br>

    {{ form.meta_keywords.label_tag }}
    {{ form.meta_keywords }}<br><br>

    {{ form.meta_description.label_tag }}
    {{ form.meta_description }}<br><br>


   

    <br>
    <button type="submit" class="btn btn-success">Save</button>
</form>

<script>
    // References
    const titleInput = document.getElementById("id_title");
    const slugInput = document.getElementById("id_slug");
    const warning = document.getElementById("slug-warning");

    // Get current article ID if editing, empty for Add
    const articleId = "{{ form.instance.pk|default:'' }}";

    // AUTO-GENERATE SLUG FROM TITLE
    titleInput.addEventListener("input", function() {
        let slug = this.value
            .toLowerCase()
            .trim()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
        slugInput.value = slug;

        // Immediately check slug after generating
        checkSlug(slug);
    });

    // CHECK SLUG WHEN TYPING MANUALLY
    slugInput.addEventListener("input", function() {
        checkSlug(this.value);
    });

    function checkSlug(slug) {
        if (!slug) {
            warning.style.display = "none";
            return;
        }

        // Include article ID for edit page
        let url = `/articles/check-slug/?slug=${slug}`;
        if (articleId) {
            url += `&id=${articleId}`;
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                warning.style.display = data.exists ? "block" : "none";
            });
    }

    // LIVE IMAGE PREVIEW
    const fileInput = document.getElementById('id_image');
    const preview = document.getElementById('preview');

    fileInput.addEventListener('change', function(event){
        const [file] = fileInput.files;
        if(file){
            preview.src = URL.createObjectURL(file); // display selected image
            preview.style.display = 'block';         // make visible
        } else {
            preview.src = "";
            preview.style.display = 'none';
        }
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {

        document.getElementById("readmore-btn").addEventListener("click", function () {

            // CKEditor 4 instance
            const editor = CKEDITOR.instances['id_content'];

            if (!editor) {
                alert("Editor not ready");
                return;
            }

            // Insert Read More marker
            editor.insertHtml('<hr class="read-more" />');

        });

    });
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const previewImg = document.getElementById("preview");
    const removeBtn = document.getElementById("remove-image-btn");
    const fileInput = document.getElementById("id_image");
    const fileInputContainer = document.getElementById("file-input-container");
    const imagePathDiv = document.getElementById("image-path");

    // Hidden input to mark deletion
    let deleteInput = document.createElement("input");
    deleteInput.type = "hidden";
    deleteInput.name = "remove_image";
    deleteInput.value = "0";
    if(previewImg?.parentElement) previewImg.parentElement.appendChild(deleteInput);

    // Update path helper
    function updatePath(path) {
        if(path){
            imagePathDiv.textContent = "Path: " + path;
        } else {
            imagePathDiv.textContent = "";
        }
    }

    // Remove image click
    if(removeBtn){
        removeBtn.addEventListener("click", function() {
            previewImg.style.display = "none";       // hide preview
            fileInput.value = "";                     // clear file input
            deleteInput.value = "1";                 // mark for deletion
            removeBtn.style.display = "none";        // hide × button
            updatePath("");                           // clear path
            fileInputContainer.style.display = "block"; // show choose file button
        });
    }

    // File input change (new selection)
    if(fileInput){
        fileInput.addEventListener("change", function() {
            const file = fileInput.files[0];
            if(file){
                previewImg.src = URL.createObjectURL(file);
                previewImg.style.display = "block";
                removeBtn.style.display = "flex";
                deleteInput.value = "0";  // user added new file
                updatePath(file.name);    // show file name
                fileInputContainer.style.display = "none"; // hide choose file button
            } else {
                previewImg.style.display = "none";
                removeBtn.style.display = "none";
                updatePath("");
                fileInputContainer.style.display = "block"; // show button
            }
        });
    }
});
</script>

{% endblock %}
