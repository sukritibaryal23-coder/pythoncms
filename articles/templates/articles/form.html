{% extends "base.html" %}
{% block content %}
{{ form.media }}
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Bootstrap JS Bundle (includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<div class="d-flex justify-content-end position-sticky mt-2" style="top: 50px; z-index: 1020;">
    <a href="{% url 'article_list' %}" class="btn btn-primary">
        Back
    </a>
</div>

<br>


<br>

<h3>{% if form.instance.pk %}Edit Article â€“ {{ form.instance.title }}{% else %}Add Article{% endif %}</h3>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    {{ form.title.label_tag }}<br>
    {{ form.title }}
    {% if form.title.errors %}
    <div class="text-danger">
        {{ form.title.errors }}
    </div>
    {% endif %}<br><br>

    {{ form.sub_title.label_tag }}<br>
    {{ form.sub_title }}<br><br>

    {{ form.slug.label_tag }}<br>
    {{ form.slug }}<br>
    <span id="slug-warning" style="color:red; display:none;">Slug already exists!</span><br>

    {{ form.media }} <!-- outputs the ckeditor.css/js you showed -->


    {{ form.content.label_tag }}<br>
    {{ form.content }}<br>
    <script src="https://cdn.ckeditor.com/4.22.1/full-all/ckeditor.js"></script>
    <script>
        CKEDITOR.replace('id_content', {
            height: 300,
            width: '100%',
            extraPlugins: 'codesnippet',
            on: {
                instanceReady: function (evt) {
                    var editor = evt.editor;

                    // Always output HR as the dashed read-more line
                    editor.dataProcessor.writer.setRules('hr', {
                        attributes: {
                            'class': 'read-more',
                            'style': 'border:2px dashed orange;'
                        },
                        selfClosingEnd: '>'
                    });
                }
            }
        });
    </script>



    <button type="button" id="readmore-btn" class="btn btn-warning mb-3">
        Read More
    </button>
    <script>
        window.addEventListener('load', function () {
            var btn = document.getElementById('readmore-btn');
            if (!btn) return;

            btn.addEventListener('click', function () {
                var editor = CKEDITOR.instances['id_content'];
                if (!editor) {
                    alert("Editor not ready");
                    return;
                }

                var html = editor.getData() || "";

                // Allow only ONE special Read More line
                if (html.indexOf('class="read-more"') !== -1) {
                    alert("Only one Read More line is allowed.");
                    return;
                }

                editor.insertHtml(
                    '<hr class="read-more" style="border:2px dashed orange;" />'
                );
            });
        });
    </script>




    <br><br>

    <input type="hidden" name="delete_image" id="delete-image-flag" value="0">
    <div class="mb-3">
        {{ form.image.label_tag }}

        <!-- Default file input -->
        <div id="file-input-container" {% if form.instance and form.instance.image %}style="display:none;" {% endif %}>
            {{ form.image }}<br>
            <small>Image Dimensions (1920 px X 1280 px)</small>
        </div>

        <!-- IMAGE PATH BELOW BUTTON -->
        <div id="image-path" style="margin-top: 5px; font-size: 0.9rem; color: #555;">
            {% if form.instance and form.instance.image %}
            Path: {{ form.instance.image.url }}
            {% endif %}
        </div>

        <!-- IMAGE PREVIEW WITH REMOVE BUTTON -->
        <div id="image-preview-container" style="position: relative; display: inline-block; margin-top: 5px;">
            <img id="preview"
                src="{% if form.instance and form.instance.image %}{{ form.instance.image.url }}{% endif %}" width="200"
                style="display: {% if form.instance and form.instance.image %}block{% else %}none{% endif %}; border-radius:8px;" />

            <button type="button" id="remove-image-btn" style="
            position: absolute;
            top: -10px;
            right: -10px;
            background: red;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: {% if form.instance and form.instance.image %}flex{% else %}none{% endif %};
            align-items: center;
            justify-content: center;">Ã—</button>
        </div>
    </div>


    {{ form.status.label_tag }}
    {{ form.status }}<br><br>
    <input type="hidden" name="metadata_opened" id="metadata_opened" value="0">

    <!-- Button with arrow -->
    <button class="btn btn-secondary mb-3 d-flex justify-content-between align-items-center" type="button"
        data-bs-toggle="collapse" data-bs-target="#metadata-section" aria-expanded="false"
        aria-controls="metadata-section">
        Metadata
        <i class="bi bi-chevron-down ms-2"></i> <!-- arrow icon -->
    </button>

    <!-- Collapsible section -->
    <div class="collapse" id="metadata-section">
        <div class="card card-body">
            <div class="mb-3">
                {{ form.meta_title.label_tag }}<br>
                {{ form.meta_title }}
                <small class="text-muted">
                    <span id="title-left">60</span> characters left
                </small>
            </div>

            <div class="mb-3">
                {{ form.meta_keywords.label_tag }}<br>
                {{ form.meta_keywords }}
                <small class="text-muted">
                    <span id="keywords-left">250</span> characters left
                </small>
            </div>

            <div class="mb-3">
                {{ form.meta_description.label_tag }}<br>
                {{ form.meta_description }}
                <small class="text-muted">
                    <span id="description-left">160</span> characters left
                </small>
            </div>
        </div>
    </div>

    <br>
    <div>
        <button type="submit" name="action" value="save" class="btn btn-success">Save</button>
        <button type="submit" name="action" value="save_more" class="btn btn-success">Save & More</button>
        <button type="submit" name="action" value="save_quit" class="btn btn-success">Save & Quit</button>

    </div>
</form>


<script>

    // References
    const titleInput = document.getElementById("id_title");
    const slugInput = document.getElementById("id_slug");
    const warning = document.getElementById("slug-warning");

    // Get current article ID if editing, empty for Add
    const articleId = "{{ form.instance.pk|default:'' }}";

    // AUTO-GENERATE SLUG FROM TITLE
    titleInput.addEventListener("input", function () {
        let slug = this.value
            .toLowerCase()
            .trim()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
        slugInput.value = slug;

        // Immediately check slug after generating
        checkSlug(slug);
    });

    // CHECK SLUG WHEN TYPING MANUALLY
    slugInput.addEventListener("input", function () {
        checkSlug(this.value);
    });

    function checkSlug(slug) {
        if (!slug) {
            warning.style.display = "none";
            return;
        }

        // Include article ID for edit page
        let url = `/articles/check-slug/?slug=${slug}`;
        if (articleId) {
            url += `&id=${articleId}`;
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                warning.style.display = data.exists ? "block" : "none";
            });
    }

    // LIVE IMAGE PREVIEW
    const fileInput = document.getElementById('id_image');
    const preview = document.getElementById('preview');

    fileInput.addEventListener('change', function (event) {
        const [file] = fileInput.files;
        if (file) {
            preview.src = URL.createObjectURL(file); // display selected image
            preview.style.display = 'block';         // make visible
        } else {
            preview.src = "";
            preview.style.display = 'none';
        }
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const removeBtn = document.getElementById("remove-image-btn");
        const preview = document.getElementById("preview");
        const fileInputContainer = document.getElementById("file-input-container");
        const imagePath = document.getElementById("image-path");
        const fileInput = fileInputContainer.querySelector("input[type=file]");
        const deleteFlag = document.getElementById("delete-image-flag"); // ðŸ”¹ define the hidden input

        if (removeBtn) {
            removeBtn.addEventListener("click", function () {
                // Hide preview and remove button
                preview.style.display = "none";
                removeBtn.style.display = "none";

                // Show file input again
                fileInputContainer.style.display = "block";

                // Clear file input and image path
                if (fileInput) fileInput.value = "";
                imagePath.textContent = "";

                // ðŸ”´ Set delete flag to 1 so Django deletes the image
                if (deleteFlag) deleteFlag.value = "1";
            });
        }

        // Live preview for newly selected file
        if (fileInput) {
            fileInput.addEventListener("change", function () {
                const file = this.files[0];
                if (file) {
                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        preview.src = e.target.result;
                        preview.style.display = "block";
                        removeBtn.style.display = "flex";
                        fileInputContainer.style.display = "none";
                        imagePath.textContent = file.name;

                        // ðŸ”¹ Reset delete flag if a new file is chosen
                        if (deleteFlag) deleteFlag.value = "0";
                    }
                    reader.readAsDataURL(file);
                }
            });
        }
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const collapseEl = document.getElementById('metadata-section');
        const button = collapseEl.previousElementSibling; // the button
        const icon = button.querySelector('i');

        collapseEl.addEventListener('show.bs.collapse', function () {
            icon.classList.remove('bi-chevron-down');
            icon.classList.add('bi-chevron-up');
        });

        collapseEl.addEventListener('hide.bs.collapse', function () {
            icon.classList.remove('bi-chevron-up');
            icon.classList.add('bi-chevron-down');
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {

        const metadataSection = document.getElementById("metadata-section");
        const metadataOpened = document.getElementById("metadata_opened");

        const titleInput = document.getElementById("meta_title");
        const keywordsInput = document.getElementById("meta_keywords");
        const descriptionInput = document.getElementById("meta_description");

        const titleLeft = document.getElementById("title-left");
        const keywordsLeft = document.getElementById("keywords-left");
        const descriptionLeft = document.getElementById("description-left");

        function updateTitle() {
            titleLeft.textContent = 60 - titleInput.value.length;
        }

        function updateKeywords() {
            keywordsLeft.textContent = 250 - keywordsInput.value.length;
        }

        function updateDescription() {
            descriptionLeft.textContent = 160 - descriptionInput.value.length;
        }

        // Initial update (edit form case)
        updateTitle();
        updateKeywords();
        updateDescription();

        titleInput.addEventListener("input", updateTitle);
        keywordsInput.addEventListener("input", updateKeywords);
        descriptionInput.addEventListener("input", updateDescription);

        // ðŸ”¥ Toggle required based on dropdown
        metadataSection.addEventListener("shown.bs.collapse", function () {
            metadataOpened.value = "1";
            titleInput.required = true;
            keywordsInput.required = true;
            descriptionInput.required = true;
        });

        metadataSection.addEventListener("hidden.bs.collapse", function () {
            metadataOpened.value = "0";
            titleInput.required = false;
            keywordsInput.required = false;
            descriptionInput.required = false;
        });
    });
</script>



{% endblock %}