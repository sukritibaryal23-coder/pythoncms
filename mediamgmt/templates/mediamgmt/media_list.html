{% extends "base.html" %}
{% block content %}

<!-- External libs -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
.object-fit-cover { object-fit: cover; }
.card video { width: 100%; height: 100%; object-fit: cover; }
.drag-handle { cursor: grab; }
</style>

<div class="container mt-5">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-3">
            <h3 class="mb-0">Media Library</h3>

            <form method="get" id="mediaFilterForm">
                <select name="media_type" class="form-select"
                        onchange="this.form.submit()">
                    <option value="image" {% if media_type == "image" %}selected{% endif %}>Images</option>
                    <option value="video" {% if media_type == "video" %}selected{% endif %}>Videos</option>
                </select>
            </form>

            <!-- View Toggle -->
            <div class="btn-group">
                <button class="btn btn-outline-secondary btn-sm" id="listViewBtn">
                    <i class="bi bi-list"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm" id="gridViewBtn">
                    <i class="bi bi-grid-3x3-gap"></i>
                </button>
            </div>
        </div>

        {% if media_type == "image" %}
            <a href="{% url 'mediamgmt:media_form' %}" class="btn btn-primary">Add Image</a>
        {% else %}
            <a href="{% url 'mediamgmt:media_video_form' %}" class="btn btn-primary">Add Video</a>
        {% endif %}
    </div>

    <hr>

    <!-- ================= LIST VIEW ================= -->
    <table class="table table-striped table-hover" id="media-table">
        <thead class="table-dark">
            <tr>
                <th></th>
                <th>Title</th>
                <th>Status</th>
                <th width="160">Action</th>
            </tr>
        </thead>
        <tbody id="media-table-body">
            {% for media in page_obj %}
            <tr data-id="{{ media.id }}">
                <td><i class="bi bi-grip-vertical drag-handle"></i></td>
                <td>{{ media.title }}</td>
                <td>
                    <button class="btn btn-sm toggle-status-btn
                        {% if media.is_active %}btn-success{% else %}btn-secondary{% endif %}"
                        data-id="{{ media.id }}">
                        {% if media.is_active %}Published{% else %}Unpublished{% endif %}
                    </button>
                </td>
                <td>
                    <a href="{% url 'mediamgmt:media_form' media.id %}" class="btn btn-sm btn-primary">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <button class="btn btn-sm btn-danger delete-media-btn"
                            data-id="{{ media.id }}">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="text-center">No media found</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- ================= GRID VIEW ================= -->
    <div class="row g-3 d-none" id="media-grid">
        {% for media in page_obj %}
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
            <div class="card shadow-sm h-100">

                <!-- Preview -->
                <div class="ratio ratio-16x9 bg-dark">
                    {% if media.media_type == "image" %}
                        <img src="{{ media.file.url }}"
                             class="img-fluid object-fit-cover">
                    {% else %}
                        {% if media.youtube_url %}
                            <iframe
                                src="https://www.youtube.com/embed/{{ media.youtube_url|cut:'https://www.youtube.com/watch?v=' }}"
                                frameborder="0"
                                allowfullscreen></iframe>
                        {% elif media.file %}
                            <video src="{{ media.file.url }}" muted></video>
                        {% endif %}
                    {% endif %}
                </div>

                <!-- Info -->
                <div class="card-body p-2">
                    <strong class="d-block text-truncate">{{ media.title }}</strong>
                    <span class="badge {% if media.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                        {% if media.is_active %}Published{% else %}Unpublished{% endif %}
                    </span>
                </div>

                <!-- Actions -->
                <div class="card-footer d-flex justify-content-between p-2">
                    <a href="{% url 'mediamgmt:media_form' media.id %}"
                       class="btn btn-sm btn-primary">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <button class="btn btn-sm btn-danger delete-media-btn"
                            data-id="{{ media.id }}">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

</div>

<!-- ================= JS ================= -->

<script>
/* View toggle */
const tableView = document.getElementById("media-table");
const gridView = document.getElementById("media-grid");

document.getElementById("gridViewBtn").onclick = () => {
    tableView.classList.add("d-none");
    gridView.classList.remove("d-none");
    localStorage.setItem("mediaView", "grid");
};

document.getElementById("listViewBtn").onclick = () => {
    gridView.classList.add("d-none");
    tableView.classList.remove("d-none");
    localStorage.setItem("mediaView", "list");
};

document.addEventListener("DOMContentLoaded", () => {
    if (localStorage.getItem("mediaView") === "grid") {
        tableView.classList.add("d-none");
        gridView.classList.remove("d-none");
    }
});

/* Drag reorder (list view only) */
new Sortable(document.getElementById("media-table-body"), {
    handle: ".drag-handle",
    animation: 150,
    onEnd() {
        const order = [...document.querySelectorAll("tr[data-id]")]
            .map(tr => tr.dataset.id);

        fetch("{% url 'mediamgmt:media_reorder' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ order })
        });
    }
});

/* Delete */
document.addEventListener("click", e => {
    const btn = e.target.closest(".delete-media-btn");
    if (!btn) return;

    if (!confirm("Delete this media?")) return;

    fetch(`/media/delete/${btn.dataset.id}/`, {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) location.reload();
        else alert(data.message);
    });
});

/* Toggle status */
document.addEventListener("click", e => {
    const btn = e.target.closest(".toggle-status-btn");
    if (!btn) return;

    fetch(`/media/toggle-status/${btn.dataset.id}/`, {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            btn.classList.toggle("btn-success", data.status);
            btn.classList.toggle("btn-secondary", !data.status);
            btn.textContent = data.status ? "Published" : "Unpublished";
        }
    });
});
</script>

{% endblock %}
