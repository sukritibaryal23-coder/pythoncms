{% extends "base.html" %}
{% block content %}
{% load static %}
{% load contentmgmt_extras %}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    .media-thumbnail { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; }
    .status-badge { font-size: 0.8em; padding: 4px 8px; border-radius: 12px; }
    .bulk-actions { margin-bottom: 15px; }
    .table-hover tbody tr:hover { background-color: #f8f9fa; }
</style>

<div id="status-toggle-message"></div>
<div id="action-message"></div>

<!-- Header -->
<header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
    <div style="display:flex; align-items:center; gap:12px;">
        <h2 style="margin:0;">
            <i class="fas fa-images me-2"></i>
            Media Dashboard
        </h2>
        <div id="saveMsg" class="status-badge bg-success">Active</div>
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                Folder: {{ current_folder.name|default:"Root" }}
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{% url 'contentmgmt:media_dashboard' %}">Root</a></li>
                {% for crumb in breadcrumbs %}
                <li><a class="dropdown-item" href="{% url 'contentmgmt:media_dashboard_folder' crumb.id %}">{{ crumb.name }}</a></li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <a href="#" class="btn btn-primary" id="bulk-upload-trigger">
        <i class="fas fa-cloud-upload-alt me-1"></i>Add Media
    </a>
</header>
<hr><br>

<!-- Bulk Actions -->
<div class="bulk-actions mb-3">
    <div class="btn-group btn-group-sm" role="group">
        <button id="bulk-publish" class="btn btn-success">Status</button>
        <button id="bulk-delete" class="btn btn-danger">Delete Selected</button>
        <button id="create-folder-btn" class="btn btn-info">
            <i class="fas fa-folder-plus me-1"></i>New Folder
        </button>
    </div>
    <div class="float-end">
        <span class="badge bg-info me-2">{{ folders|length }} folders</span>
        <span class="badge bg-primary">{{ files|length }} files</span>
    </div>
</div>

<!-- Folders Section -->
{% if folders %}
<div class="mb-4">
    <h5><i class="fas fa-folder me-1"></i>Folders ({{ folders|length }})</h5>
    <div class="row g-2 mb-3">
        {% for folder in folders %}
        <div class="col-auto">
            <div class="card border-0 shadow-sm p-2 text-center" style="width: 120px;">
                <i class="fas fa-folder fa-2x text-warning mb-2"></i>
                <div class="small fw-bold">{{ folder.name|truncatechars:15 }}</div>
                <div class="btn-group btn-group-sm mt-1">
                    <a href="{% url 'contentmgmt:media_dashboard_folder' folder.id %}" class="btn btn-outline-primary">
                        <i class="fas fa-folder-open"></i>
                    </a>
                    <button class="btn btn-outline-danger delete-item" data-type="folder" data-id="{{ folder.id }}" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-outline-warning toggle-status" data-type="folder" data-id="{{ folder.id }}" title="Toggle">
                        <i class="fas fa-toggle-{{ folder.is_active|yesno:'on,off' }}"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- DataTable -->
<table id="mediaTable" class="table table-striped table-hover" style="width:100%">
    <thead class="table-dark">
        <tr>
            <th><input type="checkbox" id="select-all"></th>
            <th>Preview</th>
            <th>Name</th>
            <th>Folder</th>
            <th>Size</th>
            <th>Uploaded</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for file in files %}
        <tr data-id="{{ file.id }}">
            <td><input type="checkbox" name="selected_files" value="{{ file.id }}"></td>
            <td>
                {% if file.file.url|is_image %}
                <img src="{{ file.file.url }}" class="media-thumbnail" alt="{{ file.name }}" loading="lazy">
                {% else %}
                <i class="fas fa-file fa-lg text-muted"></i>
                {% endif %}
            </td>
            <td>{{ file.name|truncatechars:30 }}</td>
            <td>{{ file.folder.name|default:"Root" }}</td>
            <td>{{ file.file.size|filesizeformat|default:"N/A" }}</td>
            <td>{{ file.uploaded_at|date:"M j, Y H:i" }}</td>
            <td>
                <span class="status-badge {% if file.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                    {% if file.is_active %}Active{% else %}Inactive{% endif %}
                </span>
            </td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <a href="{{ file.file.url }}" class="btn btn-outline-info" download title="Download">
                        <i class="fas fa-download"></i>
                    </a>
                    <button class="btn btn-outline-primary edit-btn" data-id="{{ file.id }}" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger delete-item" data-type="file" data-id="{{ file.id }}" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-outline-warning toggle-status" data-type="file" data-id="{{ file.id }}" title="Toggle Status">
                        <i class="fas fa-toggle-{{ file.is_active|yesno:'on,off' }}"></i>
                    </button>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if not files and not folders %}
<div class="text-center py-5 mt-5">
    <i class="fas fa-images fa-5x text-muted mb-4"></i>
    <h4 class="text-muted">No media files yet</h4>
    <p class="text-muted mb-4">Get started by uploading files or creating folders.</p>
    <button class="btn btn-primary btn-lg" id="create-folder-btn">
        <i class="fas fa-folder-plus me-2"></i>Create Folder
    </button>
</div>
{% endif %}

<script src="{% static 'js/media.js' %}"></script>

<script>
$(document).ready(function() {
    // DataTable initialization
    $('#mediaTable').DataTable({
        pageLength: 25,
        responsive: true,
        order: [[5, 'desc']], // Sort by uploaded date
        columnDefs: [
            { orderable: false, targets: [0, 6, 7] }, // Disable sorting on checkboxes, status, actions
            { width: '60px', targets: 1 } // Preview column
        ],
        language: {
            search: "Search media...",
            lengthMenu: "Show _MENU_ per page"
        }
    });

    // CSRF helper
    function getCsrfToken() {
        return $('[name=csrfmiddlewaretoken]').val() || document.cookie.match(/csrftoken=([^;]+)/)?.[1];
    }

    // Select all checkbox
    $('#select-all').on('change', function() {
        $('tbody input[type="checkbox"]').prop('checked', this.checked);
    });

    // Bulk actions
    $('#bulk-publish').click(function() {
        const selected = $('tbody input:checked');
        if (selected.length === 0) return alert('Select items first');
        // Implement bulk status toggle
        console.log('Bulk publish:', selected.length, 'items');
    });

    $('#bulk-delete').click(function() {
        if (!confirm('Delete selected items?')) return;
        const selectedIds = $('tbody input:checked').map(function() { return $(this).val(); }).get();
        // Implement bulk delete
        console.log('Bulk delete:', selectedIds);
    });

    // Create folder
    $('#create-folder-btn').click(function() {
        const name = prompt('Folder name:');
        if (!name) return;
        $.post("{% url 'contentmgmt:create_folder' %}", {
            name: name,
            parent: "{{ current_folder.id|default_if_none:'' }}",
            csrfmiddlewaretoken: getCsrfToken()
        }).done(function(res) {
            if (res.success) location.reload();
            else alert('Error: ' + (res.error || 'Failed'));
        });
    });

    // Delete item
    $(document).on('click', '.delete-item', function(e) {
        e.preventDefault();
        if (!confirm('Delete this item?')) return;
        const $btn = $(this), id = $btn.data('id'), type = $btn.data('type');
        $.post("{% url 'contentmgmt:delete_item' %}", {
            id: id, type: type,
            csrfmiddlewaretoken: getCsrfToken()
        }).done(function(res) {
            if (res.success) $btn.closest('tr, .card').fadeOut(300);
            else alert('Error: ' + (res.error || 'Failed'));
        });
    });

    // Toggle status
    $(document).on('click', '.toggle-status', function() {
        const $btn = $(this), id = $btn.data('id'), type = $btn.data('type');
        $.post("{% url 'contentmgmt:toggle_status' %}", {
            id: id, type: type,
            csrfmiddlewaretoken: getCsrfToken()
        }).done(function(res) {
            if (res.success) {
                const icon = res.status ? 'on' : 'off';
                $btn.html(`<i class="fas fa-toggle-${icon}"></i>`);
                $btn.closest('tr').find('.status-badge')
                    .removeClass('bg-success bg-secondary')
                    .addClass(res.status ? 'bg-success' : 'bg-secondary')
                    .text(res.status ? 'Active' : 'Inactive');
            }
        });
    });

    // Upload trigger
    $('#bulk-upload-trigger').click(function() {
        // Trigger file input or modal
        alert('Upload functionality - implement Dropzone modal');
    });
});
</script>
{% endblock %}
