{% extends "base.html" %}
{% block content %}
{% load static %}
{% load contentmgmt_extras %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
.file-explorer {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 16px;
}

/* Card style for folders and files */
.explorer-card, .explorer-item {
    background: #fff;
    border-radius: 8px;
    padding: 8px;
    text-align: center;
    box-shadow: 0 2px 6px rgba(0,0,0,.08);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
    position: relative;
    height: 180px; /* uniform height */
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
}

/* Hover effects */
.explorer-card:hover, .explorer-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,.12);
}

/* Hover checkbox */
.item-checkbox {
    position: absolute;
    top: 5px;
    left: 5px;
    display: none;
}

.explorer-card:hover .item-checkbox,
.explorer-item:hover .item-checkbox,
.item-checkbox:checked {
    display: block;
}

/* Icons */
.explorer-card i, .explorer-item i {
    font-size: 2.5rem;
    margin-bottom: 4px;
    color: #555;
}

/* File images/videos */
.explorer-item img,
.explorer-item video {
    width: 100%;
    height: 100px; /* uniform height */
    object-fit: cover;
    border-radius: 6px;
    cursor: pointer;
}

/* Name text */
.name {
    font-size: 0.85rem;
    margin-top: 4px;
    word-break: break-word;
    flex-shrink: 0;
}

/* Actions row */
.actions {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin-top: 6px;
    flex-wrap: wrap;
}

/* Buttons smaller */
.actions i, .actions a.btn {
    font-size: 0.9rem;
    padding: 4px 6px;
}

/* Toggle button styling */
.toggle-status {
    color: gray;
}

.toggle-status.fa-toggle-on {
    color: #28a745 !important; /* green when active */
}

/* Breadcrumb style */
.breadcrumb {
    background: #f8f9fa;
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 0.9rem;
}

.breadcrumb a {
    text-decoration: none;
    color: #0d6efd;
}

.breadcrumb a:hover {
    text-decoration: underline;
}
</style>

<header class="d-flex justify-content-between align-items-center mb-2">
    <h3><i class="fas fa-folder-open me-2"></i>Media Manager</h3>
    <div>
        <button class="btn btn-outline-secondary btn-sm" id="create-folder-btn">
            <i class="fas fa-folder-plus"></i>
        </button>
        <button class="btn btn-primary btn-sm" id="upload-btn">
            <i class="fas fa-upload"></i>
        </button>
    </div>
</header>

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-2">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{% url 'contentmgmt:media_dashboard' %}">Root</a>
        </li>
        {% if folder_path %}
            {% for folder in folder_path %}
                {% if forloop.last %}
                    <li class="breadcrumb-item active" aria-current="page">{{ folder.name }}</li>
                {% else %}
                    <li class="breadcrumb-item">
                        <a href="{% url 'contentmgmt:folder_view' folder.id %}">{{ folder.name }}</a>
                    </li>
                {% endif %}
            {% endfor %}
        {% endif %}
    </ol>
</nav>

<div class="bulk-actions mb-2 d-flex justify-content-between align-items-center">
    <div>
        <input type="checkbox" id="select-all"> <label for="select-all">Select All</label>
        <button class="btn btn-success btn-sm" id="bulk-toggle-status">Toggle</button>
        <button class="btn btn-danger btn-sm" id="bulk-delete">Delete</button>
    </div>
    <div>
        <span class="badge bg-info me-1">{{ folders|length }} folders</span>
        <span class="badge bg-primary">{{ files|length }} files</span>
    </div>
</div>

<input type="file" id="file-upload" multiple hidden>

<div class="file-explorer">
    <!-- FOLDERS -->
    {% for folder in folders %}
    <div class="explorer-card explorer-item" data-id="{{ folder.id }}" data-type="folder">
        <input type="checkbox" class="item-checkbox">
        <div class="icon-wrapper">
            <i class="fas fa-folder text-warning"></i>
        </div>
        <div class="name">{{ folder.name|truncatechars:18 }}</div>
        <div class="actions">
            <a class="btn btn-sm btn-outline-danger action-btn delete-item" data-type="folder" data-id="{{ folder.id }}">
                <i class="fas fa-trash"></i>
            </a>
            <button class="btn btn-sm btn-outline-secondary action-btn toggle-status" data-type="folder" data-id="{{ folder.id }}">
                <i class="fas fa-toggle-{{ folder.is_active|yesno:'on,off' }}"></i>
            </button>
        </div>
    </div>
    {% endfor %}

    <!-- FILES -->
    {% for file in files %}
    <div class="explorer-card explorer-item" data-id="{{ file.id }}" data-type="file">
        <input type="checkbox" class="item-checkbox">
        <div class="icon-wrapper">
            {% if file.file.url|is_image %}
                <img src="{{ file.file.url }}">
            {% elif file.file.url|is_video %}
                <video src="{{ file.file.url }}" muted></video>
            {% elif file.file.url|is_pdf %}
                <i class="fas fa-file-pdf text-danger"></i>
            {% else %}
                <i class="fas fa-file text-secondary"></i>
            {% endif %}
        </div>
        <div class="name">{{ file.name|truncatechars:18 }}</div>
        <div class="actions">
            <a href="{{ file.file.url }}" download class="btn btn-sm btn-outline-info action-btn">
                <i class="fas fa-download"></i>
            </a>
            <a class="btn btn-sm btn-outline-danger action-btn delete-item" data-type="file" data-id="{{ file.id }}">
                <i class="fas fa-trash"></i>
            </a>
            <button class="btn btn-sm btn-outline-secondary action-btn toggle-status" data-type="file" data-id="{{ file.id }}">
                <i class="fas fa-toggle-{{ file.is_active|yesno:'on,off' }}"></i>
            </button>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content p-0">
      <div class="modal-body p-0">
        <img id="preview-image" class="img-fluid w-100 d-none" alt="Preview">
        <video id="preview-video" class="w-100 d-none" controls autoplay></video>
      </div>
      <div class="modal-footer p-2">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
        <a href="#" id="download-preview" class="btn btn-primary btn-sm" download>Download</a>
      </div>
    </div>
  </div>
</div>

<script>
$(document).ready(function() {

    function getCsrfToken() {
        return document.cookie.match(/csrftoken=([^;]+)/)?.[1];
    }

    // Upload
    $('#upload-btn').click(() => $('#file-upload').click());
    $('#file-upload').on('change', function () {
        const formData = new FormData();
        for (let file of this.files) formData.append('file', file);
        formData.append('folder', "{{ current_folder.id|default:'' }}");
        formData.append('csrfmiddlewaretoken', getCsrfToken());
        $.ajax({
            url: "{% url 'contentmgmt:upload_file' %}",
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: () => location.reload()
        });
    });

    // Create folder
    $('#create-folder-btn').click(() => {
        const name = prompt("Folder name");
        if(!name) return;
        $.post("{% url 'contentmgmt:create_folder' %}", {
            name: name,
            parent: "{{ current_folder.id|default:'' }}",
            csrfmiddlewaretoken: getCsrfToken()
        }).done(() => location.reload());
    });

    // Double-click folder / file
    $('.explorer-card, .explorer-item').on('dblclick', function(){
        const type = $(this).data('type');
        const id = $(this).data('id');

        if(type === 'folder') {
            window.location.href = "{% url 'contentmgmt:folder_view' 0 %}".replace('/0/', '/' + id + '/');
        } else if(type === 'file') {
            const $img = $(this).find('img');
            const $video = $(this).find('video');
            if($img.length){
                $('#preview-image').attr('src', $img.attr('src')).removeClass('d-none');
                $('#preview-video').addClass('d-none');
            } else if($video.length){
                $('#preview-video').attr('src', $video.attr('src')).removeClass('d-none');
                $('#preview-image').addClass('d-none');
            }
            $('#download-preview').attr('href', $(this).find('a').attr('href'));
            const myModal = new bootstrap.Modal(document.getElementById('previewModal'));
            myModal.show();
        }
    });

    // Delete without reload
    $(document).on('click', '.delete-item', function(e){
        e.stopPropagation();
        if(!confirm("Delete this item?")) return;
        const $btn = $(this);
        const $card = $btn.closest('[data-id]');
        const id = $btn.data('id');
        const type = $btn.data('type');
        $.post("{% url 'contentmgmt:delete_item' %}", {
            id: id,
            type: type,
            csrfmiddlewaretoken: getCsrfToken()
        }).done(res => {
            if(res.success){
                $card.fadeOut(200, function(){ $(this).remove(); });
            }
        });
    });

    // Toggle status
    $(document).on('click', '.toggle-status', function(e){
        e.stopPropagation();
        const $btn = $(this);
        const id = $btn.data('id');
        const type = $btn.data('type');
        $.post("{% url 'contentmgmt:toggle_status' %}", {
            id: id,
            type: type,
            csrfmiddlewaretoken: getCsrfToken()
        }).done(res => {
            if(res.success){
                const icon = res.status ? 'on' : 'off';
                $btn.find('i').removeClass('fa-toggle-on fa-toggle-off').addClass('fa-toggle-' + icon);
            }
        });
    });

    // Select all
    $('#select-all').on('change', function() {
        $('.item-checkbox').prop('checked', this.checked);
    });

    // Bulk toggle status
    $('#bulk-toggle-status').on('click', function() {
        const selected = $('.item-checkbox:checked');
        if(!selected.length) return alert("Select items first.");
        selected.each(function(){
            const $card = $(this).closest('[data-id]');
            const id = $card.data('id');
            const type = $card.data('type');
            $.post("{% url 'contentmgmt:toggle_status' %}", {
                id: id,
                type: type,
                csrfmiddlewaretoken: getCsrfToken()
            }).done(res => {
                if(res.success){
                    const $icon = $card.find('.toggle-status i');
                    const icon = res.status ? 'on' : 'off';
                    $icon.removeClass('fa-toggle-on fa-toggle-off').addClass('fa-toggle-' + icon);
                }
            });
        });
    });

    // Bulk delete
    $('#bulk-delete').on('click', function() {
        const selected = $('.item-checkbox:checked');
        if(!selected.length) return alert("Select items first.");
        if(!confirm("Delete selected items?")) return;
        selected.each(function(){
            const $card = $(this).closest('[data-id]');
            const id = $card.data('id');
            const type = $card.data('type');
            $.post("{% url 'contentmgmt:delete_item' %}", {
                id: id,
                type: type,
                csrfmiddlewaretoken: getCsrfToken()
            }).done(res => { if(res.success) $card.fadeOut(200, function(){ $(this).remove(); }); });
        });
    });

});
</script>
{% endblock %}
